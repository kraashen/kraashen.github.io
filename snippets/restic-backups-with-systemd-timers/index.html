<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Restic Backups with Systemd Timers | tracing bytes</title>
<meta name=keywords content="linux,backup,systemd"><meta name=description content="Backing up with Restic using systemd timers. Using SFTP with key login as the backend.
Prerequisites mkdir /opt/restic mkdir /opt/restic/.ssh mkdir /opt/restic/.cache touch /opt/restic/restic.env touch /opt/restic/.restic-password # put in place touch /opt/restic/.ssh/config # fill as necessary chmod 600 /opt/restic/.restic-password ssh-keygen -t ed25519 -f /opt/restic/.ssh/restic chmod 600 /opt/restic/.ssh/restic ssh-keyscan -H host >> /opt/restic/.ssh/known_hosts cat <<EOF > /opt/restic/restic.env RESTIC_REPOSITORY=sftp:user@host:/path/to/repo RESTIC_PASSWORD_FILE=/opt/restic/.restic-password RESTIC_CACHE_DIR=/opt/restic/.cache EOF Service # /etc/systemd/system/restic-backup.service [Unit] Description=Restic Backup Wants=network-online.target After=network-online.target [Service] Type=oneshot WorkingDirectory=/opt/restic EnvironmentFile=/opt/restic/restic."><meta name=author content><link rel=canonical href=https://kraashen.github.io/snippets/restic-backups-with-systemd-timers/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://kraashen.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kraashen.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kraashen.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://kraashen.github.io/apple-touch-icon.png><link rel=mask-icon href=https://kraashen.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kraashen.github.io/snippets/restic-backups-with-systemd-timers/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Restic Backups with Systemd Timers"><meta property="og:description" content="Backing up with Restic using systemd timers. Using SFTP with key login as the backend.
Prerequisites mkdir /opt/restic mkdir /opt/restic/.ssh mkdir /opt/restic/.cache touch /opt/restic/restic.env touch /opt/restic/.restic-password # put in place touch /opt/restic/.ssh/config # fill as necessary chmod 600 /opt/restic/.restic-password ssh-keygen -t ed25519 -f /opt/restic/.ssh/restic chmod 600 /opt/restic/.ssh/restic ssh-keyscan -H host >> /opt/restic/.ssh/known_hosts cat <<EOF > /opt/restic/restic.env RESTIC_REPOSITORY=sftp:user@host:/path/to/repo RESTIC_PASSWORD_FILE=/opt/restic/.restic-password RESTIC_CACHE_DIR=/opt/restic/.cache EOF Service # /etc/systemd/system/restic-backup.service [Unit] Description=Restic Backup Wants=network-online.target After=network-online.target [Service] Type=oneshot WorkingDirectory=/opt/restic EnvironmentFile=/opt/restic/restic."><meta property="og:type" content="article"><meta property="og:url" content="https://kraashen.github.io/snippets/restic-backups-with-systemd-timers/"><meta property="article:section" content="snippets"><meta property="article:published_time" content="2024-07-29T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-29T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Restic Backups with Systemd Timers"><meta name=twitter:description content="Backing up with Restic using systemd timers. Using SFTP with key login as the backend.
Prerequisites mkdir /opt/restic mkdir /opt/restic/.ssh mkdir /opt/restic/.cache touch /opt/restic/restic.env touch /opt/restic/.restic-password # put in place touch /opt/restic/.ssh/config # fill as necessary chmod 600 /opt/restic/.restic-password ssh-keygen -t ed25519 -f /opt/restic/.ssh/restic chmod 600 /opt/restic/.ssh/restic ssh-keyscan -H host >> /opt/restic/.ssh/known_hosts cat <<EOF > /opt/restic/restic.env RESTIC_REPOSITORY=sftp:user@host:/path/to/repo RESTIC_PASSWORD_FILE=/opt/restic/.restic-password RESTIC_CACHE_DIR=/opt/restic/.cache EOF Service # /etc/systemd/system/restic-backup.service [Unit] Description=Restic Backup Wants=network-online.target After=network-online.target [Service] Type=oneshot WorkingDirectory=/opt/restic EnvironmentFile=/opt/restic/restic."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Snippets","item":"https://kraashen.github.io/snippets/"},{"@type":"ListItem","position":2,"name":"Restic Backups with Systemd Timers","item":"https://kraashen.github.io/snippets/restic-backups-with-systemd-timers/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Restic Backups with Systemd Timers","name":"Restic Backups with Systemd Timers","description":"Backing up with Restic using systemd timers. Using SFTP with key login as the backend.\nPrerequisites mkdir /opt/restic mkdir /opt/restic/.ssh mkdir /opt/restic/.cache touch /opt/restic/restic.env touch /opt/restic/.restic-password # put in place touch /opt/restic/.ssh/config # fill as necessary chmod 600 /opt/restic/.restic-password ssh-keygen -t ed25519 -f /opt/restic/.ssh/restic chmod 600 /opt/restic/.ssh/restic ssh-keyscan -H host \u0026gt;\u0026gt; /opt/restic/.ssh/known_hosts cat \u0026lt;\u0026lt;EOF \u0026gt; /opt/restic/restic.env RESTIC_REPOSITORY=sftp:user@host:/path/to/repo RESTIC_PASSWORD_FILE=/opt/restic/.restic-password RESTIC_CACHE_DIR=/opt/restic/.cache EOF Service # /etc/systemd/system/restic-backup.service [Unit] Description=Restic Backup Wants=network-online.target After=network-online.target [Service] Type=oneshot WorkingDirectory=/opt/restic EnvironmentFile=/opt/restic/restic.","keywords":["linux","backup","systemd"],"articleBody":"Backing up with Restic using systemd timers. Using SFTP with key login as the backend.\nPrerequisites mkdir /opt/restic mkdir /opt/restic/.ssh mkdir /opt/restic/.cache touch /opt/restic/restic.env touch /opt/restic/.restic-password # put in place touch /opt/restic/.ssh/config # fill as necessary chmod 600 /opt/restic/.restic-password ssh-keygen -t ed25519 -f /opt/restic/.ssh/restic chmod 600 /opt/restic/.ssh/restic ssh-keyscan -H host \u003e\u003e /opt/restic/.ssh/known_hosts cat \u003c /opt/restic/restic.env RESTIC_REPOSITORY=sftp:user@host:/path/to/repo RESTIC_PASSWORD_FILE=/opt/restic/.restic-password RESTIC_CACHE_DIR=/opt/restic/.cache EOF Service # /etc/systemd/system/restic-backup.service [Unit] Description=Restic Backup Wants=network-online.target After=network-online.target [Service] Type=oneshot WorkingDirectory=/opt/restic EnvironmentFile=/opt/restic/restic.env # run restic with sftp.command to use the separate ssh config and known_hosts ExecStart=/usr/bin/restic -o sftp.command=\"ssh user@host -F /opt/restic/.ssh/config -o UserKnownHostsFile=/opt/restic/.ssh/known_hosts -s sftp\" backup /mnt/disk --verbose Nice=19 IOSchedulingClass=best-effort IOSchedulingPriority=7 ProtectSystem=full ProtectHome=yes PrivateTmp=yes [Install] WantedBy=multi-user.target Timer # /etc/systemd/system/restic-backup.timer [Unit] Description=Run Restic backup monthly [Timer] OnCalendar=*-*-01 00:00:00 Persistent=true [Install] WantedBy=timers.target Testing # Enable and start the timer systemctl start restic-backup.service # Check the status systemctl status restic-backup.service # Check the logs journalctl -u restic-backup.service TODOs Separate user and group for the service. Adding the user to the required groups to have read access to all files (no need for sudo). ","wordCount":"170","inLanguage":"en","datePublished":"2024-07-29T00:00:00Z","dateModified":"2024-07-29T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://kraashen.github.io/snippets/restic-backups-with-systemd-timers/"},"publisher":{"@type":"Organization","name":"tracing bytes","logo":{"@type":"ImageObject","url":"https://kraashen.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kraashen.github.io/ accesskey=h title="tracing bytes (Alt + H)">tracing bytes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kraashen.github.io/ title=Home><span>Home</span></a></li><li><a href=https://kraashen.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://kraashen.github.io/snippets/ title=Snippets><span>Snippets</span></a></li><li><a href=https://kraashen.github.io/my-library/ title="My Library"><span>My Library</span></a></li><li><a href=https://kraashen.github.io/interests/ title=Interests><span>Interests</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Restic Backups with Systemd Timers</h1><div class=post-meta><span title='2024-07-29 00:00:00 +0000 UTC'>July 29, 2024</span></div></header><div class=post-content><p>Backing up with Restic using systemd timers.
Using SFTP with key login as the backend.</p><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /opt/restic
</span></span><span class=line><span class=cl>mkdir /opt/restic/.ssh
</span></span><span class=line><span class=cl>mkdir /opt/restic/.cache
</span></span><span class=line><span class=cl>touch /opt/restic/restic.env 
</span></span><span class=line><span class=cl>touch /opt/restic/.restic-password <span class=c1># put in place</span>
</span></span><span class=line><span class=cl>touch /opt/restic/.ssh/config <span class=c1># fill as necessary</span>
</span></span><span class=line><span class=cl>chmod <span class=m>600</span> /opt/restic/.restic-password
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ssh-keygen -t ed25519 -f /opt/restic/.ssh/restic
</span></span><span class=line><span class=cl>chmod <span class=m>600</span> /opt/restic/.ssh/restic
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ssh-keyscan -H host &gt;&gt; /opt/restic/.ssh/known_hosts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; /opt/restic/restic.env
</span></span></span><span class=line><span class=cl><span class=s>RESTIC_REPOSITORY=sftp:user@host:/path/to/repo
</span></span></span><span class=line><span class=cl><span class=s>RESTIC_PASSWORD_FILE=/opt/restic/.restic-password
</span></span></span><span class=line><span class=cl><span class=s>RESTIC_CACHE_DIR=/opt/restic/.cache
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h2 id=service>Service<a hidden class=anchor aria-hidden=true href=#service>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># /etc/systemd/system/restic-backup.service</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Restic Backup
</span></span><span class=line><span class=cl><span class=nv>Wants</span><span class=o>=</span>network-online.target
</span></span><span class=line><span class=cl><span class=nv>After</span><span class=o>=</span>network-online.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Type</span><span class=o>=</span>oneshot
</span></span><span class=line><span class=cl><span class=nv>WorkingDirectory</span><span class=o>=</span>/opt/restic
</span></span><span class=line><span class=cl><span class=nv>EnvironmentFile</span><span class=o>=</span>/opt/restic/restic.env
</span></span><span class=line><span class=cl><span class=c1># run restic with sftp.command to use the separate ssh config and known_hosts</span>
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/restic -o sftp.command<span class=o>=</span><span class=s2>&#34;ssh user@host -F /opt/restic/.ssh/config -o UserKnownHostsFile=/opt/restic/.ssh/known_hosts -s sftp&#34;</span> backup /mnt/disk --verbose
</span></span><span class=line><span class=cl><span class=nv>Nice</span><span class=o>=</span><span class=m>19</span>
</span></span><span class=line><span class=cl><span class=nv>IOSchedulingClass</span><span class=o>=</span>best-effort
</span></span><span class=line><span class=cl><span class=nv>IOSchedulingPriority</span><span class=o>=</span><span class=m>7</span>
</span></span><span class=line><span class=cl><span class=nv>ProtectSystem</span><span class=o>=</span>full
</span></span><span class=line><span class=cl><span class=nv>ProtectHome</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl><span class=nv>PrivateTmp</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></div><h2 id=timer>Timer<a hidden class=anchor aria-hidden=true href=#timer>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># /etc/systemd/system/restic-backup.timer</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Run Restic backup monthly
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Timer<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>OnCalendar</span><span class=o>=</span>*-*-01 00:00:00
</span></span><span class=line><span class=cl><span class=nv>Persistent</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>timers.target
</span></span></code></pre></div><h2 id=testing>Testing<a hidden class=anchor aria-hidden=true href=#testing>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Enable and start the timer</span>
</span></span><span class=line><span class=cl>systemctl start restic-backup.service
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Check the status</span>
</span></span><span class=line><span class=cl>systemctl status restic-backup.service
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Check the logs</span>
</span></span><span class=line><span class=cl>journalctl -u restic-backup.service
</span></span></code></pre></div><h2 id=todos>TODOs<a hidden class=anchor aria-hidden=true href=#todos>#</a></h2><ul><li>Separate user and group for the service.</li><li>Adding the user to the required groups to have read access to all files
(no need for <code>sudo</code>).</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://kraashen.github.io/tags/linux/>Linux</a></li><li><a href=https://kraashen.github.io/tags/backup/>Backup</a></li><li><a href=https://kraashen.github.io/tags/systemd/>Systemd</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://kraashen.github.io/>tracing bytes</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>